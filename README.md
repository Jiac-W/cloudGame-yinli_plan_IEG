## CloudGame-RTSP-CGIServer-Yinli_Plan

**本项目依赖于Linux环境，结合RTSP流协议，实现了云服务器Centos 7 抓屏编码推流，并在本地Ubuntu系统结合QT实现拉流解码显示，以及采集本地操作指令上传云端实现交互。**



云游戏将游戏资源、运行、内容的存储、计算和渲染都转移到云端，实时的游戏画面串流到终端进行显示，最终呈现到用户眼中。与本地游戏相比，云游戏增加了【抓屏、编码、网络传输、解码】等主要过程，即**流化过程**。

- **图1云游戏典型架构图**

![云游戏基本原理示意图](photos/云游戏基本原理示意图.jpg)

<img src="photos/0-Overview.png" style="zoom: 15%;" />



### **云平台技术**

**x86 架构的云平台主要针对于 PC 端游和主机游戏的云化，ARM 架构的云平台主要针对手游的云化。**

1. **GPU 虚拟化与无盘**

   - 目前云平台的资源管理和调度有两种主流的方案——**【虚拟化方案】和【物理机方案】。**
     - **虚拟机流派**一般采用服务器和专业显卡的云端资源组合，并以虚拟化的方式分配资源，较为灵活。

2. **音视频抓取**

   - 流化的第一步是抓取游戏的实时画面，如果是 PC 游戏，则是抓取屏幕的画面。
   - **本方案云端是基于Centos 7，因此采用`x11grab`进行抓屏；**

3. **编码技术**

   **云端在抓取到原始游戏画面后，由于数据量巨大，不宜直接传输，需要经过编码压缩后才做网络传输。**

   - **a）H264 和 H265 是常见的视频编码标准。**

     **H264** 相较于以前的编码标准，增加了参考帧的运动补偿、帧内预测等新特性，视频质量更高，码率更低，因此得到了广泛使用。

     **H265** 在架构上与 H264 相似，但 H265 在图像分块、变换编码、预测编码、熵编码等模块上提出了更优的算法，提高了编码的压缩率、鲁棒性，在相同画质的情况下理论上 H265 能比 H264 节省一半的带宽。

     - 不过，H265 压缩率的提升使得解码的复杂度更高，理论上解码的运算量约是 H264 的 2 倍，所以对解码硬件提出了更高要求。

     **本方案根据现有可用服务器资源，以及权衡码率和图像质量两者之间的关系，最终决定采用`H264`的编码方式。**

     无论使用 H264 还是 H265 进行编码，都需要**对码率大小**和**图像质量**进行权衡，并选择**合适的编码参数**。

   - **b）硬编码和软编码**

     **软编码**是使用 CPU 进行编码，实现直接、简单，**同码率下质量较高**，但由于对 CPU 的负载较重，性能相对较低。

     **硬解码**主要使用 GPU 等进行编码，性能高，速度快，但同码率下**质量不如软编码。**

     **通常，云游戏对于延迟的要求非常严苛，因此一般采用硬编码。**

     注释：结合本项目可用资源的特性，当时申请到的是**腾讯云CVM高IO型服务器**，所以采用软编码的方式实现。

   - **c）无B帧编码**

     编码序列中一般有 I 帧、B 帧、P 帧，**其中 I 帧是关键帧，P 帧是前向预测编码帧，B 帧是双向预测编码帧。**

     **云游戏从编码的时延、效率、实现复杂度等角度考虑，常常采用无 B 帧编码。**

     - **即第一帧是 I 帧，之后的都是 P 帧，只有在网络很差导致了断连的情况下，才会重新再发一个 I 帧。**

     - **无 B 帧编码的优势是**，除了 I 帧，之后的每一帧，都可以根据前面一帧来完成编码，实现简单，而且每抓屏一次就可以立刻送往编码，不产生额外的延迟。相应的，P 帧的压缩率较低，需要的带宽更大。

     - **有 B 帧编码的优势是**，B 帧压缩率更高，更节省带宽，但 B 帧需要等到后面的 P 帧才能完成编码，所以产生了**至少一个帧间隔的延迟**。

     **时延优化是云游戏的重点，因此无 B 帧编码是优选，I 帧后续都是 P 帧，也利于保持帧间隔的稳定。**

     **音频也有编码标准**，常见的有 AAC、MP3、WMA、PCM 等，但由于音频的数据量比较小，有些云游戏平台并没有做音频的编码压缩过程，而是采样后直接传输。

4. **推流技术**

   - **云游戏业务对时延要求高，任何过多的报文封装和解封装都会引入额外的时延。**

   - **目前主要采用 TCP 或 UDP 直接封装应用层数据。**

     - **TCP传输过程中，丢包、乱序等引发重传，会导致游戏的操作响应变慢。**

     - **UDP不会重传，实时性较好，但丢包时损失了画面质量。**